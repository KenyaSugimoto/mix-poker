# 12_実装計画.md

## 1. 目的
本書は、MVP（フロント完結・CPU対戦）を実装するための具体的な開発計画を定義する。

- フォルダ構成（責務ごとの分離）
- 依存方向（UI ← store ← domain の一方向）
- テスト戦略（Vitest）
- 作業順（マイルストーン）

---

## 2. 前提（本計画が依拠する仕様）
- UIは SETUP / PLAY / HISTORY / SETTINGS の4画面（11参照）
- 永続化は **手動保存**で、保存タイミングは `STREET_ADVANCE` / `DEAL_END` のみ（10/11参照）
- 履歴は `GameState.dealHistory: DealSummary[]`（最大200、要約）
- フル保存は直近10のみ（`fullStore.fullDealsById`）
- お気に入りは **フル保存が存在するディールのみ**（直近10内のみ可能、最大50）
- プレイヤー人数は **2〜7**（UI側で確定。後続ドキュメントに波及予定）

---

## 3. 技術スタック（前提）
- React + Vite
- TypeScript
- Zustand（ただし persist ミドルウェアは使用しない）
- Vitest（ユニットテスト）
- Biome
- Zod
- TailwindCSS

---

## 4. フォルダ構成（推奨）

```txt
src/
  app/
    store/
      appStore.ts              # Zustand store（AppState）
      actions.ts               # UI/エンジンから呼ぶ store action 群
      persistence.ts           # loadAppState/saveAppState（localStorage）
    bootstrap.ts               # 起動時の load → store 初期化
  domain/
    types/
      index.ts                 # 共通型（GameState/DealState/Events/...）
    engine/
      applyEvent.ts            # DealStateへEvent適用（純関数）
      reducers/                # eventごとの適用ロジック（純関数）
      invariants.ts            # 不整合検知（開発用）
    rules/
      allowedActions.ts        # getAllowedActions（純関数）
      actor.ts                 # currentActor/nextActor/bring-in判定など（純関数）
      bet.ts                   # ベット額/差分/committed更新（純関数）
      street.ts                # ストリート進行条件（純関数）
    cards/
      dealing.ts               # カード配布（08_カード配布設計書に合わせる）
    showdown/
      resolveShowdown.ts       # 役判定（07）
      distributePot.ts         # ポット分配（07）
      scores.ts                # deltaStacks算出等
    cpu/
      policy.ts                # CPU意思決定（MVP）
      runner.ts                # CPUターンを連続適用するオーケストレーション（純関数寄り）
    utils/
      id.ts                    # dealId生成など
      clamp.ts                 # 上限処理
  ui/
    pages/
      SetupPage.tsx
      PlayPage.tsx
      HistoryPage.tsx
      SettingsPage.tsx
    components/
      GameTypeSelector.tsx     # 種目選択（複数選択・並び替え可能）
      GameHeader.tsx
      TableView/
        TableView.tsx
        SeatPanel.tsx
        PlayerCards.tsx
        ActiveIndicator.tsx
      ActionPanel.tsx
      DealResultBanner.tsx
      DealSummaryList.tsx
      DealDetailPanel.tsx
    hooks/
      useAppStore.ts           # selector薄ラッパ（任意）
  test/
    domain/
      engine.test.ts
      allowedActions.test.ts
      showdown.test.ts
      distributePot.test.ts
    app/
      persistence.test.ts
      storeFlow.test.ts
```

### ポイント
- `domain/` は **ReactやZustandに依存しない**（純関数中心）
- `app/store` は **UIから呼ばれる窓口**（action）と永続化を持つ
- `ui/` は描画と操作に徹し、ゲームロジックを持たない

---

## 5. 責務分離（依存方向）
### 5.1 依存の向き
- `ui` → `app(store/actions)` → `domain`
- `domain` は `ui` / `app` を import しない（逆依存禁止）

### 5.2 Storeの責務（App層）
- UIイベント（ボタン操作）を domain event に変換して適用
- CPUターンの連続適用（runner呼び出し）
- 重要イベント後の `saveAppState()` 呼び出し
- 破損復元時のフォールバック（game=null 等）

### 5.3 Domainの責務
- DealStateの更新（applyEvent）
- allowedActions、actor、bet、street進行
- showdown/分配/履歴要約生成（DealSummary）

---

## 6. 永続化（方式A：手動保存）実装方針
### 6.1 保存の呼び出し箇所
- store action 内で、イベント適用後に
  - `event.type === "STREET_ADVANCE"` の **適用完了後**
  - `event.type === "DEAL_END"` の **終了確定処理完了後**
  に `saveAppState(getState())` を呼ぶ

### 6.2 localStorage失敗時
- 例外を握りつぶさず、`lastLoadError` や toast で通知（MVPはログでも可）
- ただしゲーム進行自体は継続可能にする（保存失敗＝即停止にしない）

---

## 7. テスト戦略（Vitest）

### 7.1 Domainユニットテスト（最優先）
- `applyEvent`：イベント適用で期待どおりにDealStateが更新される
- `allowedActions`：ストリート/状況別に許可アクションが正しい
- `actor`：bring-in / 次アクター / ストリート終了条件
- `bet`：committed/pot/stack の差分更新
- `resolveShowdown` / `distributePot`：勝者決定と端数処理

> ここが安定すれば、UIは薄く保てるため、保守コストが大きく下がる。

### 7.2 Storeフローテスト（次点）
- 「SETUP→startDeal→数イベント→STREET_ADVANCE→save呼び出し」
- 「DEAL_END→履歴追加→full保存更新→save呼び出し」
- localStorageはモック（in-memory）で検証

### 7.3 UIテスト（MVPでは任意）
- まずは domain/store を固め、UIは手動確認中心でよい
- 余裕があれば PlayPage の「ボタン押下で action が呼ばれる」程度のスモークテスト

---

## 8. 作業順（マイルストーン）

### TODO
完了したマイルストーンは、下記にチェックを入れる。

- [x] M0：プロジェクト骨組み
- [x] M1：Domain最小ループ
- [x] M2：Store + 永続化
- [x] M3：SETUP画面
- [ ] M4：PLAY画面（最小）
- [ ] M5：カード表示
- [ ] M6：ショーダウン/分配/履歴
- [ ] M7：HISTORY / SETTINGS

---

### M0：プロジェクト骨組み（0.5〜1日）
- Vite + React + TS
- Vitest導入、テストが1本走る状態
- フォルダ構成（4章）を作成

成果物：
- `domain/types` の最低限の型
- `test/domain/smoke.test.ts`

---

### M1：Domain最小ループ（1〜2日）
- DealStateの最小構造
- applyEvent（まずは ante / bring-in / bet / call / fold など最小）
- ストリート進行（STREET_ADVANCE）
- allowedActions（最小）

成果物：
- Domainユニットテスト（allowedActions / actor / applyEvent）

---

### M2：Store + 永続化（方式A）（1日）
- `loadAppState` / `saveAppState` 実装
- 起動時 bootstrap（復元→store初期化）
- 重要イベント時のみ save（STREET_ADVANCE / DEAL_END）

成果物：
- `persistence.test.ts`
- `storeFlow.test.ts`（save呼び出し含む）

---

### M3：SETUP画面（1日）
- プレイヤー人数（2〜7）
- human/cpu、名前、stakes、dealPerGame
- 種目選択（StudHi/Razz/Stud8）
  - MVPは **ドラッグ&ドロップを後回し**にし、最初は「↑↓ボタンで並び替え」でも可
- start → Playへ

成果物：
- `SetupPage` + store action（createNewGame/startDeal）

---

### M4：PLAY画面（最小）（2〜3日）
- TableView（seat表示、stack/committed、fold状態）
- currentActorIndex のハイライト
- ActionPanel（allowedActionsをボタンで表示→押下でイベント発行）
- CPUターンの自動進行（短いdelayは任意）

成果物：
- Humanで1周進行できる

---

### M5：カード表示（MVP範囲）（1〜2日）
- PlayerCards
  - レイアウト：`d1 d2 u1 u2 u3 u4 d3`
  - Humanはdown表示、他は裏
- DEAL_CARDS_* イベント（既存イベント設計に合わせる）

※ 「カード配布設計書」の採番は、このタイミングで確定させる（後述）

---

### M6：ショーダウン/分配/履歴（2〜3日）
- 07に沿って `resolveShowdown` / `distributePot`
- DEAL_END処理（winner, deltaStacks）
- `GameState.dealHistory` に DealSummary追加（最大200）
- `fullStore` に直近10フル保存、evict実行
- お気に入り制約（フルがあるディールのみ）

成果物：
- 1ディール完結→次ディール開始まで通る

---

### M7：HISTORY / SETTINGS（1〜2日）
- HISTORY：要約一覧→詳細（フルあり/なし）
- お気に入りボタン（フルありのときのみ有効）
- SETTINGS：表示単位、全データ削除（confirm）

成果物：
- 一通りのMVP UXが完成

---

## 9. 採番/ドキュメント整合（確認済み）
採番は確定済み、衝突なし。詳細は [README.md](./README.md) を参照。

---

## 10. 受け入れ条件（MVP Done）
- SETUPで種目順を設定し、PLAYで進行できる
- CPUが一定のルールで行動できる
- STREET_ADVANCE / DEAL_END のタイミングで保存され、再起動で復元できる
- HISTORYでDealSummary（最大200）が見える
- 直近10はフル詳細が見える（最低限でOK）
- お気に入り（最大50）は直近10内でのみ付与できる（フルがある場合のみ）

---
