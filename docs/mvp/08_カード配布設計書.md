# 08_カード配布設計書.md

## 1. 目的
本書は、Stud系ゲームにおける **デッキ管理（生成・シャッフル・ドロー）** と **ストリート進行に沿ったカード配布（down/upの割り当て）** を定義する。

- DealState を正（Single Source of Truth）として、配布結果が再現可能であることを重視する
- MVPでは「オンライン対戦」ではなく「CPU対戦・フロント完結」を前提とする

---

## 2. スコープ
対象：
- Stud Hi / Razz / Stud8
- 3rd〜7th の配布（7-card stud）

対象外（将来）：
- デッドカード（人数過多で配り切れない場合の特殊処理）
- 手札公開・Muck 等のUI演出

---

## 3. 設計方針

### 3.1 再現性（Determinism）
- 同一の入力（seed とイベント列）から **同一の配布結果**を再現できるようにする
- そのために deck は DealState に保持し、ドローは deck から取り除く（破壊的消費）

### 3.2 イベント駆動
- 配布は Event により状態を更新する
- UI/CPU はカードを直接書き換えない

---

## 4. データモデル

### 4.1 Card / Deck

```ts
export type Suit = "c" | "d" | "h" | "s";
export type Rank = "A" | "K" | "Q" | "J" | "T" | "9" | "8" | "7" | "6" | "5" | "4" | "3" | "2";

export interface Card {
  suit: Suit;
  rank: Rank;
}

export type Deck = Card[];
```

### 4.2 PlayerHand（ディール内のカード状態）
- Studは最大7枚（down最大3 / up最大4）

```ts
export interface PlayerHand {
  downCards: Card[]; // 裏
  upCards: Card[];   // 表
}
```

### 4.3 DealState への追加
- 03_状態設計書.md の DealState に以下を追加する

```ts
export interface DealState {
  // ...既存

  deck: Deck;
  rngSeed: string; // 再現性のため
  hands: Record<SeatIndex, PlayerHand>;
}
```

※ `hands` はアクティブでないseatにも保持してよい（履歴/表示の都合）  
※ 配布対象は「active seat」のみ

---

## 5. RNG / シャッフル仕様

### 5.1 RNG seed
- `rngSeed` はディール開始時に確定する
- `Date.now()` 等から生成（プレイの多様性優先）

※ テストでは固定 seed を必須とする

### 5.2 シャッフル
- `createDeck()` で 52枚生成後、`shuffle(deck, rngSeed)` を実行する
- シャッフルの実装は「seed付き疑似乱数」に基づくこと

```ts
export const createDeck = (): Deck => {
  // 52枚生成（重複なし）
};

export const shuffleDeck = (deck: Deck, seed: string): Deck => {
  // seed付き Fisher–Yates を推奨
  // 返り値は新しい配列（純関数）でも、stateに格納する時点で確定すればよい
  return deck;
};
```

---

## 6. 配布仕様（Stud：3rd〜7th）

### 6.1 ストリートごとの配布枚数
- 3rd：down 2 + up 1
- 4th：up 1
- 5th：up 1
- 6th：up 1
- 7th：down 1

### 6.2 配布対象
- 配布対象は `player.active === true` の seat のみ
- foldしたseatには以降のカードは配らない

---

## 7. イベント設計（カード配布用）

### 7.1 EventType 追加
04_イベント設計書.md の EventType に以下を追加する。

- `DEAL_INIT`（ディール開始：deck/seed/hands初期化）
- `DEAL_CARDS_3RD`
- `DEAL_CARD_4TH`
- `DEAL_CARD_5TH`
- `DEAL_CARD_6TH`
- `DEAL_CARD_7TH`

※ 3rdのみ「複数枚配布」なのでまとめイベントにする（ログが冗長になりすぎるのを避ける）

### 7.2 DEAL_INIT
```ts
export interface DealInitEvent extends BaseEvent {
  type: "DEAL_INIT";
  seat: null;
  street: null;
  rngSeed: string;
}
```

**applyEvent責務**
- deck = shuffle(createDeck(), rngSeed)
- hands を初期化（全seatに empty hand を用意）
- rngSeed を state に保存

### 7.3 DEAL_CARDS_3RD
```ts
export interface DealCards3rdEvent extends BaseEvent {
  type: "DEAL_CARDS_3RD";
  seat: null;
  street: "3rd";
}
```

**applyEvent責務**
- active seat の順（seat昇順）で以下を行う：
  - downCards に2枚追加
  - upCards に1枚追加
  - deck から消費（shift/pop）

### 7.4 4th〜7th（1枚ずつ）
```ts
export interface DealCardEvent extends BaseEvent {
  type: "DEAL_CARD_4TH" | "DEAL_CARD_5TH" | "DEAL_CARD_6TH" | "DEAL_CARD_7TH";
  seat: null;
  street: "4th" | "5th" | "6th" | "7th";
}
```

**applyEvent責務**
- active seat の順（seat昇順）で以下を行う：
  - 4th/5th/6th：upCards に1枚追加
  - 7th：downCards に1枚追加
  - deck から消費

---

## 8. 配布の呼び出しタイミング（エンジン責務）

### 8.1 ディール開始時
- `DEAL_INIT` → `POST_ANTE*` → `DEAL_CARDS_3RD` → 3rd開始

### 8.2 ストリート遷移時
- `STREET_ADVANCE` の直後に、次ストリートに応じた DEAL イベントを発火する

例：
- 3rd終了 → STREET_ADVANCE → DEAL_CARD_4TH
- 4th終了 → STREET_ADVANCE → DEAL_CARD_5TH
...

※ カード配布は「ストリート開始時」に行う（UI的にも自然）

---

## 9. ガード（不正防止）

### 9.1 デッキ不足
- MVP前提では playerCount<=8 のため原則不足しない
- ただし `deck.length` が足りない場合は例外を投げる（またはdeal abort）

### 9.2 配布枚数上限
- downCards は最大3
- upCards は最大4
- それを超える追加はバグとみなし例外

---

## 10. 役判定（07）への接続

### 10.1 7枚生成
```ts
export const getAllCardsForSeat = (s: DealState, seat: SeatIndex): Card[] => {
  const h = s.hands[seat];
  return [...h.downCards, ...h.upCards];
};
```

### 10.2 評価呼び出し
- 7th完了後、active seat の cards を作り `resolveShowdown` に渡す

---

## 11. テスト観点（Vitest）

- createDeck が 52枚で重複なし
- shuffleDeck が seed により再現可能
- DEAL_CARDS_3RD で各active seatに down2+up1 が配られる
- 4th〜7th で active seat のみに1枚ずつ配られる
- fold済みseatには以降配られない
- 7th後、各active seatの合計枚数が7（down3/up4）
- 同seedなら配布結果が一致する

---

## 12. 次のドキュメント
- 09_GameState（Mix全体）設計書.md（ディール連結、ローテ、スコア）
- 10_AppState / 永続化設計.md
