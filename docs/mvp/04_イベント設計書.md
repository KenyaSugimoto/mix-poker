# 04_イベント設計書.md（ハイブリッド方式：pending + checks 更新版）

## 1. 目的
ディール進行を構成する **イベント（Event）** の種類・構造・責務を定義する。  
すべての状態遷移は **Event → applyEvent → DealState更新** によって行われる。

- UI / CPU は **Eventを直接Stateに反映してはならない**
- Event列から DealState が再現可能であることを前提とする

---

## 2. ハイブリッド方式（重要）

### 2.1 pendingResponseCount（攻撃への応答待ち）
- 攻撃（BRING_IN / COMPLETE / BET / RAISE）が発生したら
  - `pendingResponseCount = active人数 - 1`
  - `checksThisStreet = 0`（以降はcheckフェーズではないため）
- 応答（CALL / FOLD）が発生したら
  - `pendingResponseCount--`
- `pendingResponseCount === 0` でストリート終了（STREET_ADVANCE）

### 2.2 checksThisStreet（全員checkで終了）
- `currentBet === 0` のときに発生する CHECK ごとに
  - `checksThisStreet++`
- `checksThisStreet === active人数` でストリート終了（STREET_ADVANCE）
- 攻撃が発生したら `checksThisStreet = 0`

---

## 3. Event共通構造

```ts
export type EventId = string;

export interface BaseEvent {
  id: EventId;
  type: EventType;
  seat: SeatIndex | null; // 全体イベントはnull
  street: Street | null;  // ストリート非依存イベントはnull
  timestamp: number;
}
```

---

## 4. EventType一覧（MVP）

```ts
export type EventType =
  | "POST_ANTE"
  | "BRING_IN"
  | "COMPLETE"
  | "BET"
  | "RAISE"
  | "CALL"
  | "FOLD"
  | "CHECK"
  | "STREET_ADVANCE"
  | "DEAL_END";
```

---

## 5. 各イベントの定義と責務

### 5.1 POST_ANTE
**目的**：ディール開始時に全員がanteを支払う

```ts
export interface PostAnteEvent extends BaseEvent {
  type: "POST_ANTE";
  seat: SeatIndex;
  street: null;
  amount: number; // = ante
}
```

**applyEvent責務**
- player.stack -= amount
- player.committedTotal += amount
- pot += amount
- pendingResponseCount / checksThisStreet は変更しない
※ 全員分をまとめて処理せず、**seatごとにEventを発行**する  
※ Event順がそのままリプレイ順になる
---

### 5.2 BRING_IN（3rdのみ）
**目的**：3rd Streetでbring-inを成立させる

```ts
export interface BringInEvent extends BaseEvent {
  type: "BRING_IN";
  seat: SeatIndex;
  street: "3rd";
  amount: number; // = bringIn
}
```

**applyEvent責務**
- player.stack -= amount
- player.committedTotal += amount
- player.committedThisStreet += amount
- pot += amount
- `currentBet = bringIn`
- `raiseCount = 0`
- `pendingResponseCount = active人数 - 1`
- `checksThisStreet = 0`

---

### 5.3 COMPLETE（3rdのみ）
**目的**：bring-in を smallBet まで引き上げる

**前提条件 (下記を満たす場合のみ許可)**：
- `street === "3rd"`
- `committedThisStreet === 0`
- `currentBet < smallBet` (currentBet === 0 または bringIn)

※ bring-in 対象者・非対象者を問わず成立し得る  
※ bring-in 対象者が bring-in 後に COMPLETE するケースは、本仕様では発生しない
  （bring-in が一周した時点で自動的にストリート終了とするため）

### 【補足】3rd Street の自動終了仕様
- 3rd Street において bring-in が成立し、
  以降だれも COMPLETE / RAISE を行わずにコールで一周した場合、
  bring-in 対象者に追加の選択肢を与えず STREET_ADVANCE を発火する。

```ts
export interface CompleteEvent extends BaseEvent {
  type: "COMPLETE";
  seat: SeatIndex;
  street: "3rd";
  amount: number; // = smallBet - bringIn
}
```

**applyEvent責務**
- player.stack -= amount
- player.committedTotal += amount
- player.committedThisStreet += amount
- pot += amount
- `currentBet = smallBet`
- `raiseCount = 0`
- `pendingResponseCount = active人数 - 1`
- `checksThisStreet = 0`

---

### 5.4 BET
**目的**：そのストリート最初の攻撃アクション

```ts
export interface BetEvent extends BaseEvent {
  type: "BET";
  seat: SeatIndex;
  street: Street;
  amount: number; // = streetBetUnit
}
```

**applyEvent責務**
- player.stack -= amount
- player.committedTotal += amount
- player.committedThisStreet += amount
- pot += amount
- `currentBet = amount`
- `raiseCount = 0`
- `pendingResponseCount = active人数 - 1`
- `checksThisStreet = 0`

---

### 5.5 RAISE
**目的**：既存のbetに対するレイズ

```ts
export interface RaiseEvent extends BaseEvent {
  type: "RAISE";
  seat: SeatIndex;
  street: Street;
  amount: number; // = streetBetUnit
}
```

**applyEvent責務**
- player.stack -= amount
- player.committedTotal += amount
- player.committedThisStreet += amount
- pot += amount
- `currentBet += amount`
- `raiseCount += 1`
- `pendingResponseCount = active人数 - 1`
- `checksThisStreet = 0`

---

### 5.6 CALL
**目的**：現在のbetに追従する

```ts
export interface CallEvent extends BaseEvent {
  type: "CALL";
  seat: SeatIndex;
  street: Street;
  amount: number; // = toCall
}
```

**applyEvent責務**
- player.stack -= amount
- player.committedTotal += amount
- player.committedThisStreet += amount
- pot += amount
- `pendingResponseCount--`

---

### 5.7 FOLD
**目的**：ディールから離脱する

```ts
export interface FoldEvent extends BaseEvent {
  type: "FOLD";
  seat: SeatIndex;
  street: Street;
}
```

**applyEvent責務**
- player.active = false
- 以下は「いま攻撃フェーズかどうか」で分岐
  - `currentBet > 0` のとき：`pendingResponseCount--`（応答した扱い）
  - `currentBet === 0` のとき：`checksThisStreet` は増やさない（foldはcheckではない）
- active人数が1になったら DEAL_END（または dealFinished=true）

---

### 5.8 CHECK（3rdは不可）
**目的**：ベットが無い状態での応答（参加継続）

```ts
export interface CheckEvent extends BaseEvent {
  type: "CHECK";
  seat: SeatIndex;
  street: Street; // 4th〜7thのみ
}
```

**applyEvent責務**
- committed / pot / currentBet / raiseCount は変更しない
- `checksThisStreet++`

---

### 5.9 STREET_ADVANCE
**目的**：次のストリートへ遷移する

```ts
export interface StreetAdvanceEvent extends BaseEvent {
  type: "STREET_ADVANCE";
  seat: null;
  street: Street; // 終了したstreet
}
```

**applyEvent責務**
- street を次へ
- players[*].committedThisStreet = 0
- currentBet = 0
- raiseCount = 0
- pendingResponseCount = 0
- checksThisStreet = 0
- actionsThisStreet = []
- currentActorIndex を次ストリート先頭へ（Actor仕様）

---

### 5.10 DEAL_END
**目的**：ディールを終了する

```ts
export interface DealEndEvent extends BaseEvent {
  type: "DEAL_END";
  seat: SeatIndex | null; // 勝者（未確定の場合はnull）
  street: Street | null;
}
```

**applyEvent責務**
- dealFinished = true
- 勝者seatを記録（ポット分配は後続）

---

## 6. ストリート終了判定の実装責務（Reducer側）
Reducer（またはエンジン）はイベント適用後に以下をチェックして、必要なら STREET_ADVANCE を発火する。

- `currentBet > 0` かつ `pendingResponseCount === 0` → STREET_ADVANCE
- `currentBet === 0` かつ `checksThisStreet === active人数` → STREET_ADVANCE
- active人数が1 → DEAL_END
- STREET_ADVANCE 発火時点の currentActorIndex は次ストリートで上書きされるため、チェックフェーズでの最終値に依存しない

---

## 7. テスト観点（Vitest）
- 4th以降：全員checkで `checksThisStreet===active人数` になり終了
- bet/raise/complete/bring-in で `pendingResponseCount=active-1` に再設定され、`checksThisStreet=0` にリセットされる
- call/fold で `pendingResponseCount--`、0で終了
- 3rdでCHECKが許可されない（allowedActions側で制御）

---

## 8. 次のドキュメント
- 05_計算仕様書.md
- 06_CPU設計書.md
