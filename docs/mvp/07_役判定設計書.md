# 07_役判定設計書.md

## 1. 目的
本書は、Stud系ゲームにおける **役判定・勝者決定・ポット分配** の設計方針を定義する。  
MVPでは以下を主対象とする。

- Stud Hi
- Razz
- Stud8（Hi/Low スプリット）

※ ディール進行（ベット・ストリート管理）は対象外（03〜06で定義済み）

---

## 2. スコープと前提

### 2.1 判定タイミング
- 7th Street 完了後
- または全員 fold により 1人が残った場合（役判定は不要）

### 2.2 カード情報
- MVPでは **カード配布ロジックは既に存在する前提**
- 各プレイヤーは以下を保持する想定
  - 表向きカード: 最大4枚
  - 裏向きカード: 最大3枚

```ts
interface PlayerHand {
  downCards: Card[]; // 裏向き
  upCards: Card[];   // 表向き
}
```

```ts
export const getAllCardsForSeat = (s: DealState, seat: SeatIndex): Card[] => {
  const h = s.hands[seat];
  return [...h.downCards, ...h.upCards];
};
```

※ Stud は「5枚固定」ではなく **最大7枚から最良5枚を選ぶ**
※ 後述する評価用関数に渡すcardの配列は `cards = getAllCardsForSeat(dealState, seat)` とする
※ 配列内のカードの順序は評価に影響しない

---

## 3. 共通概念

### 3.1 HandRank（High用）
- 通常のポーカー役（ロイヤル〜ハイカード）
- 比較は「役種 → キッカー順」

```ts
export type HandRank =
  | "HIGH_CARD"
  | "ONE_PAIR"
  | "TWO_PAIR"
  | "THREE_OF_A_KIND"
  | "STRAIGHT"
  | "FLUSH"
  | "FULL_HOUSE"
  | "FOUR_OF_A_KIND"
  | "STRAIGHT_FLUSH";
```

---

### 3.2 LowHand（Low用）
- A2345 が最強
- ストレート・フラッシュは無視
- 重複ランク不可

```ts
export interface LowHandScore {
  ranks: number[]; // 昇順（A=1, K=13）
}
```

---

## 4. Stud Hi 判定仕様

### 4.1 判定ルール
- 7枚から最良の5枚を選択
- 通常のハイポーカー評価

### 4.2 評価インターフェース

```ts
export interface HighHandResult {
  rank: HandRank;
  kickers: number[];
}
```

```ts
export const evaluateStudHi = (cards: Card[]): HighHandResult => {
  // 7枚 → best5 → HandRank算出
};
```

### 4.3 比較ルール
1. HandRank を比較
2. 同一なら kickers を上位から比較

---

## 5. Razz 判定仕様

### 5.1 判定ルール
- **最も弱い役が勝ち**
- A2345 が最強
- フラッシュ・ストレートは無視
- 重複ランクは弱くなる

### 5.2 評価インターフェース

```ts
export const evaluateRazz = (cards: Card[]): LowHandScore => {
  // 7枚 → best low 5枚 → ranks昇順
};
```

### 5.3 比較ルール
- `ranks` を **後ろ（高い数字）から**比較し、数字が小さい方が強い
  - `compareLow(a,b): number` は「aが強いなら -1、弱いなら +1、同値なら 0」

---

## 6. Stud8（Hi/Low スプリット）判定仕様

### 6.1 Low 成立条件（8-or-better）
- 5枚すべてが **8以下**
- 重複ランク不可
※ 上記条件を満たさない場合は、Lowハンドとして成立しない (null)

### 6.2 評価インターフェース

```ts
export interface Stud8Result {
  high: HighHandResult;
  low: LowHandScore | null;
}
```

```ts
export const evaluateStud8 = (cards: Card[]): Stud8Result => {
  // high は常に算出
  // low は成立条件を満たす場合のみ算出
};
```

---

## 7. 勝者決定ロジック

### 7.1 Stud Hi / Razz
- 全 active プレイヤーを評価
- 最強（Hi）または最弱（Razz）を持つプレイヤーが勝者
- 同値の場合は **チョップ**

### 7.2 Stud8
- Hi 勝者と Low 勝者を独立に決定
- Low が成立しない場合：
  - Hi 勝者が **総取り**
- Hi / Low 同一プレイヤー：
  - **総取り**

---

## 8. ポット分配仕様

### 8.1 基本
- ポットは **ante 単位**で管理されている前提
- 分配も ante 単位で行う

### 8.2 チョップ時
- 均等分配
- 割り切れない端数は **seat順で配布**（例：seat番号が若い順）

### 8.3 Stud8
- Pot / 2 を Hi / Low に分割
  - 2で割り切れない場合は、Hi側に余りを分配 (余りは ante 単位でしか起きない)
- Low 不成立なら Hi が全取り

---

## 9. インターフェースまとめ

```ts
export interface ShowdownResult {
  winnersHigh: SeatIndex[];
  winnersLow?: SeatIndex[];
}
```

```ts
export const resolveShowdown = (
  state: DealState,
  hands: Record<SeatIndex, Card[]>
): ShowdownResult => {
  // gameType に応じて評価
};
```

---

## 10. MVP外（将来拡張）
- サイドポット
- オールイン
- デッドハンド
- アップカードによる途中表示用評価
- GTO / 確率ベース評価

---

## 11. テスト観点（Vitest）

- Stud Hi：
  - 明確な勝敗
  - 完全同一役でチョップ
- Razz：
  - A2345 vs 23456
  - フラッシュ無視
- Stud8：
  - Low 成立 / 不成立
  - Hi と Low が同一 / 別プレイヤー
- ポット端数分配の正しさ

---

## 12. 次のドキュメント
- 09_GameState（Mix全体）設計書.md
- 10_AppState / 永続化設計.md
