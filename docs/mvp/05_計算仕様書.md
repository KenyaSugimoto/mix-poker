# 05_計算仕様書.md

## 1. 目的
本書は、`DealState` を更新する際に必要となる **金額計算・更新規則** を定義する。  
対象は以下：

- Eventごとの `amount` の算出
- `toCall` の定義
- `currentBet` の意味と更新式
- `pot / stack / committedTotal / committedThisStreet` の更新規則
- `pendingResponseCount / checksThisStreet` の更新規則（計算面の補足）
- 最小単位（端数）ルール

---

## 2. 前提（用語）
- 最小単位は `ante` と同一（端数は `ante` 単位でのみ存在）
- Fix Limit（3rd/4th=smallBet、5th/6th/7th=bigBet）
- 5bet cap（bet=1bet、1st raise=2bet、…、4th raise=5bet）
- 3rdはbring-in必須、check不可
- 4th以降は `currentBet===0` のときのみcheck可

---

## 3. コア概念

### 3.1 currentBet の意味（重要）
`currentBet` は **そのストリートで成立している「ベット額（到達すべき額）」** を表す。

- 3rd
  - bring-in後：`currentBet = bringIn`
  - complete後：`currentBet = smallBet`
  - raise後：`currentBet += smallBet`
- 4th〜7th
  - bet後：`currentBet = streetBetUnit`
  - raise後：`currentBet += streetBetUnit`

### 3.2 committedThisStreet の意味
各プレイヤーが **そのストリートで既に支払った累計**。

### 3.3 toCall の定義
プレイヤー `p` がコールするために追加で必要な金額。

```ts
export const getToCall = (currentBet: number, committedThisStreet: number): number =>
  Math.max(0, currentBet - committedThisStreet);
```

---

## 4. ベット単位（streetBetUnit）

```ts
export const getStreetBetUnit = (street: Street, smallBet: number, bigBet: number): number =>
  (street === "3rd" || street === "4th") ? smallBet : bigBet;
```

- 3rd/4th：smallBet
- 5th/6th/7th：bigBet

---

## 5. Eventごとの amount 算出

### 5.1 POST_ANTE
- `amount = ante`（固定）

### 5.2 BRING_IN（3rd）
- `amount = bringIn`（固定）

### 5.3 COMPLETE（3rd）
COMPLETEは「bring-inをsmallBetまで引き上げる」固定。

- `amount = smallBet`
  - ただし 前提条件として `committedThisStreet === 0` を満たす局面でのみ発生する（= allowActions 側の責務）

※ `smallBet` と `bringIn` の差は必ず `ante` の倍数になる前提  
（最小単位がanteであるため）

#### 前提条件
- COMPLETE は `player.committedThisStreet === 0` の場合のみ発生するため、
  差分計算（smallBet - bringIn 等）は不要とする。

※ bring-in を支払ったプレイヤーが後から COMPLETE するケースは、
  本仕様では発生しないため考慮しない。


### 5.4 BET（4th〜7th）
- `amount = streetBetUnit`
- ただし bet が許可されるのは `currentBet===0` のときのみ

### 5.5 RAISE（3rd〜7th）
- `amount = streetBetUnit`
- raiseが許可されるのは
  - `currentBet > 0`
  - `raiseCount < 4`（5bet cap）
  のときのみ

### 5.6 CALL（3rd〜7th）
- `amount = toCall`
- callが許可されるのは `toCall > 0` のとき（MVPでは toCall=0 call は不可とする）

```ts
export const calcCallAmount = (s: DealState, seat: SeatIndex): number =>
  Math.max(0, s.currentBet - s.players[seat].committedThisStreet);
```

### 5.7 CHECK（4th〜7th）
- `amount` を持たない（= 0）
- checkが許可されるのは `currentBet===0` のときのみ（3rd不可）

### 5.8 FOLD
- 金額は発生しない

---

## 6. スタック・ポット・コミット更新規則（共通）

### 6.1 金額が発生するイベント（POST_ANTE / BRING_IN / COMPLETE / BET / RAISE / CALL）
共通で以下を適用する。

```ts
player.stack -= amount;
player.committedTotal += amount;
player.committedThisStreet += amount;
state.pot += amount;
```

### 6.2 金額が発生しないイベント（CHECK / FOLD / STREET_ADVANCE / DEAL_END）
- stack / pot / committed は変更しない

---

## 7. currentBet / raiseCount 更新規則

### 7.1 BRING_IN（3rd）
- `currentBet = bringIn`
- `raiseCount = 0`

### 7.2 COMPLETE（3rd）
- `currentBet = smallBet`
- `raiseCount = 0`

### 7.3 BET（4th〜7th）
- `currentBet = streetBetUnit`
- `raiseCount = 0`

### 7.4 RAISE（3rd〜7th）
- `currentBet += streetBetUnit`
- `raiseCount += 1`

### 7.5 CALL / CHECK / FOLD
- `currentBet` は変更しない
- `raiseCount` は変更しない

---

## 8. ハイブリッド終了判定用カウンタ更新規則

### 8.1 攻撃イベント（BRING_IN / COMPLETE / BET / RAISE）
- `pendingResponseCount = activeCount - 1`
- `checksThisStreet = 0`

※ 「攻撃をした本人」以外が応答対象になるため `-1`

### 8.2 応答イベント（CALL）
- `pendingResponseCount--`

### 8.3 CHECK（checkフェーズ）
- `checksThisStreet++`

### 8.4 FOLD
foldは「応答」になり得るが、状況で扱いが変わる。

- `currentBet > 0`（攻撃フェーズ）：
  - foldは応答なので `pendingResponseCount--`
- `currentBet === 0`（checkフェーズ）：
  - foldはcheckではないため `checksThisStreet` は増やさない

加えて、`player.active=false` により `activeCount` は減少するため、
Reducer側で「終了条件評価に用いるactiveCount」を常に最新で算出すること。

---

## 9. ストリート遷移時（STREET_ADVANCE）のリセット

STREET_ADVANCE適用時：

- `players[*].committedThisStreet = 0`
- `currentBet = 0`
- `raiseCount = 0`
- `pendingResponseCount = 0`
- `checksThisStreet = 0`
- `actionsThisStreet = []`

---

## 10. ストリート終了条件（Reducer側チェック）

イベント適用後に、Reducer（エンジン）は以下を評価して必要なら遷移イベントを発火する。

### 10.1 攻撃フェーズ（currentBet > 0）
- `pendingResponseCount === 0` → STREET_ADVANCE（または 7th なら DEAL_END）

### 10.2 checkフェーズ（currentBet === 0）
- `checksThisStreet === activeCount` → STREET_ADVANCE（または 7th なら DEAL_END）

### 10.3 全員fold（activeCount === 1）
- DEAL_END（勝者=残ったseat）

---

## 11. 端数（最小単位）ルール
- すべての `amount` は `ante` の倍数でなければならない
- `stack / pot / committed*` は常に `ante` の倍数であること
- テストで `amount % ante === 0` を検証する

---

## 12. テスト観点（Vitest）
- toCall計算：currentBetとcommittedThisStreetから正しく算出
- COMPLETE amount：smallBet - bringIn
- RAISEでcurrentBetが +streetBetUnit される
- CALL amount が toCall と一致し、更新結果が一致する
- amountが常に ante の倍数
- foldが攻撃フェーズではpendingを減らす／checkフェーズではchecksを増やさない

---

## 13. 次のドキュメント
- 06_CPU設計書.md（chooseActionインターフェース、Lv0/Lv1）
- 07_役判定設計書.md（StudHi/Razz/Stud8の比較・ポット分配は後続）
