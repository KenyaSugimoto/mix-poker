# 11_UI設計ブリーフ.md

## 1. 目的
本書は、MVP（フロント完結・CPU対戦）の実装に直結する形で、UIの土台を定義する。

- 画面一覧
- ユーザーフロー
- 画面ごとの目的 / 主要要素 / 状態（loading/empty/error）
- 状態設計（AppState / GameState / DealState との対応）
- コンポーネント分解
- MVPでの制約（履歴要約・フル保存・お気に入り・保存頻度）

---

## 2. 前提（設計上の制約）
### 2.1 状態の階層
- AppState：アプリ全体（UI状態 + GameState + FullStore）
- GameState：Mix全体（ディール連結、スコア、履歴要約）
- DealState：ディール単位（進行、ベット、カード配布、役判定の入力）

### 2.2 永続化仕様（UIに影響）
- 永続化は手動（方式A）
- 保存タイミングは `STREET_ADVANCE` / `DEAL_END` のみ
- 履歴は `GameState.dealHistory`（最大200、要約）
- フル保存は直近10のみ（`fullStore.fullDealsById`）
- お気に入り登録は「フル保存があるディールのみ」（直近10内のみ可能）
- お気に入りは最大50（ただしフルを延命しない）

---

## 3. 画面一覧（MVP）

| Screen   | 画面名       | 目的                                           | 主な遷移先        |
| -------- | ------------ | ---------------------------------------------- | ----------------- |
| SETUP    | ゲーム設定   | プレイヤー/ステークス/ローテ設定してゲーム開始 | PLAY              |
| PLAY     | 対戦（進行） | Deal進行、アクション入力、次ディール開始       | HISTORY, SETTINGS |
| HISTORY  | 履歴         | DealSummary一覧、詳細（要約 or フル）          | PLAY              |
| SETTINGS | 設定         | 表示設定、データ削除、デバッグ情報             | SETUP             |

---

## 4. ユーザーフロー

### 4.1 初回起動
1. SETUP：設定入力
2. ゲーム開始 → PLAY（Deal開始）

### 4.2 途中再起動（復元）
1. loadAppState 成功
2. `ui.screen` に遷移（基本は PLAY 推奨）
3. `game.currentDeal` が存在すれば継続、なければ PLAY で「次ディール開始」

※ 保存頻度が重要イベントのみのため、クラッシュ復帰時は「直近ストリート開始」まで戻る可能性がある

### 4.3 プレイ中
1. PLAY：アクション可能プレイヤーが Human のとき入力
2. CPUターンは自動進行（演出はMVPでは簡素）
3. STREET_ADVANCE → 自動で配布、保存
4. DEAL_END → 勝者・分配・履歴更新、保存
5. 次ディール開始（ボタン）

### 4.4 履歴閲覧
1. HISTORY：一覧（要約）
2. item選択 → 詳細
   - フルあり：リプレイ/カード表示（可能な範囲）
   - フルなし：要約のみ
3. PLAYに戻る

---

## 5. 画面ごとの設計

## 5.1 SETUP（ゲーム設定）
### 目的
- プレイヤーとCPUを設定し、GameStateを生成する

### 主要要素
- プレイヤー人数（2〜7）
- 各seatのプレイヤー種別（human/cpu）と名前
- 初期スタック（全員同額をデフォルト）
- stakes（ante/bringIn/smallBet/bigBet）
- **種目選択（01_MVP定義書準拠）**：
  - 対象種目：StudHi / Razz / Stud8
  - 複数選択可能（最低1つ必須）
  - **順番指定可能**（ドラッグ&ドロップ）
  - 選択した種目順が `rotation.sequence` となる
- rotation.dealPerGame（何ディールごとに種目を切り替えるか）
- 「ゲーム開始」ボタン
- 「復元データ削除」（任意：SETTINGSにも置く）

### 状態
- loading：なし（ローカル）
- empty：初期表示
- error：
  - 入力バリデーション（未入力、数値不正、人数不正）

### 重要仕様
- ゲーム開始時に `game = createNewGame(...)`
- 直後に `startDeal(...)` するかはUXで選択
  - MVP推奨：開始と同時に第1ディール開始

### コンポーネント
- `SetupPage`
  - `PlayerConfigList`
    - `PlayerConfigRow`
  - `GameTypeSelector`：種目選択（複数選択・並び替え可能）
  - `StakesForm`
  - `RotationForm`：dealPerGame設定
  - `PrimaryButtonStartGame`

---

## 5.2 PLAY（対戦・進行）
### 目的
- DealStateの進行、行動入力、結果表示、次ディール開始

### 主要要素（上から）
- ヘッダー：
  - 現在のゲーム種（StudHi/Razz/Stud8）
  - ディール番号（dealIndex+1）
  - ステークス表示
  - 現在のポット
- テーブル情報：
  - **Hero（Human）は常にテーブル下部中央（6時の位置）に固定**
  - 各seatのプレイヤー表示（名前、スタック、コミット額）
  - アクティブ/フォールド状態
  - **現在のアクター（`currentActorIndex`）をハイライト表示**
  - カード表示（08_カード配布設計書準拠）：
    - アップカード（upCards）：全プレイヤー表示
      - 3rd：1枚 → 4th-6thで毎ストリート+1枚 → 最大4枚
    - ダウンカード（downCards）：
      - **Human自身：自分のダウンカードのみ表示**（3rd：2枚、7thで+1枚→最大3枚）
      - **CPU/他プレイヤー：裏面のみ表示（ショーダウン時に公開）**
    - **表示レイアウト**：
      - 配布順に並べる：`d1 d2 u1 u2 u3 u4 d3`（down2枚 → up4枚 → down1枚）
      - カードは**重ねて表示**
      - **upCardsはやや上方向にオフセット**してdown/upを視覚的に区別
- アクションパネル（Humanターン時のみ活性）：
  - allowedActions ボタン
  - amount を伴うアクションは「固定額のみ」（MVPでは選択UI不要）
- ログ（任意）：
  - 直近アクションのテキスト
  - カード配布イベント（`DEAL_CARDS_*`）も表示可
- ディール結果：
  - DEAL_END後に勝者、分配、更新スタック
  - **獲得pot額を勝者の近くに表示**（例：`+1,200`）
  - **ポット移動アニメーション**（任意）：ポットが勝者の手元に移動する演出
  - ショーダウン時は**全アクティブプレイヤーのダウンカードを公開表示**

### 状態
- loading：なし（ローカル）
- empty：
  - `game == null` → SETUPへ誘導
  - `game.currentDeal == null` → 「次ディール開始」CTA
- error：
  - 不整合（例：currentDealあるのに actor不正）
  - localStorage save失敗（トーストで通知）

### 重要仕様
- CPUターンは自動進行（連続イベント発行）
- 永続化：
  - STREET_ADVANCE 適用後に `saveAppState()`
  - DEAL_END（終了確定処理の最後）に `saveAppState()`
- 次ディール開始：
  - `startNewDeal` → `DEAL_INIT` → `POST_ANTE*` → `DEAL_CARDS_3RD`

### コンポーネント
- `PlayPage`
  - `GameHeader`
  - `TableView`
    - `SeatPanel`（×人数）
      - `PlayerName`
      - `StackDisplay`
      - `CommittedDisplay`
      - `PlayerCards`：カード表示（down/up統合、配布順に重ね表示）
      - `ActiveIndicator`：現在アクターのハイライト
  - `ActionPanel`
    - `ActionButton`（CHECK/CALL/RAISE/...）
  - `DealResultBanner`
  - `ActionLogList`（任意）

---

## 5.3 HISTORY（履歴）
### 目的
- DealSummary（最大200）の閲覧
- フル保存があるディールは詳細表示（カード/リプレイ）

### 主要要素
- 一覧（新しい順）
  - dealIndex（またはstartedAt）
  - gameType
  - winners（High/Low）
  - pot
  - deltaStacks（±）
  - “フルあり”バッジ
- 詳細ペイン（または別画面）
  - 要約：winners/pot/deltaStacks/所要時間
  - フル：加えて cards / action log（提供できる範囲）

### 状態
- loading：なし
- empty：`dealHistory.length === 0`
- error：選択中dealIdが存在しない（削除された等）

### 重要仕様（お気に入り）
- お気に入りボタンは **フル保存があるディールのみ表示/有効**
  - 条件：`fullStore.fullDealsById[dealId] != null`
- お気に入り最大50（超えたら古いものから外す）
- ルール案Aにより、お気に入りはフル保存を延命しない
  - ただし、MVPでは「お気に入り=直近10内」という制約に見えるため、UI文言で明示する

※ MVPの自然な表現：
- 「お気に入り」は “直近の検討用マーク” として扱う
- 将来、フル延命をしたくなったら仕様変更で可能

### コンポーネント
- `HistoryPage`
  - `DealSummaryList`
    - `DealSummaryRow`
  - `DealDetailPanel`
    - `DealDetailSummary`
    - `DealDetailFull`（フルがある場合のみ）
      - `CardsBySeat`
      - `ActionLogList`（フル保存に含める場合のみ）
  - `FavoriteToggleButton`（条件付き）

---

## 5.4 SETTINGS（設定）
### 目的
- 表示設定（points/bb等）
- データ削除（破損/初期化）
- デバッグ情報表示（任意）

### 主要要素
- displayUnit 切替（points/bb）
- 「全データ削除」ボタン（confirm必須）
- 保存情報の表示（任意）
  - dealHistory件数
  - full保存件数
  - localStorage使用量（可能なら）

### 状態
- loading：なし
- empty：なし
- error：なし

### コンポーネント
- `SettingsPage`
  - `DisplayUnitToggle`
  - `DangerZoneResetAll`

---

## 6. UI状態とStateの対応

### 6.1 画面遷移
- `ui.screen` が画面表示を決定
- `ui.selectedDealId` は HISTORY 詳細の対象

### 6.2 データ参照
- 現在進行：`game.currentDeal`
- 履歴要約：`game.dealHistory`
- フル詳細：`fullStore.fullDealsById[dealId]`

---

## 7. MVPの非機能要件（UI観点）
- 操作中に固まらない（保存頻度を抑える）
- CPU進行は速すぎない（任意で短いdelayを入れる）
- 復元失敗時は SETUP に戻す（lastLoadError表示）

---

## 8. 実装順（推奨）
1. SETUP（Game生成→PLAY遷移）
2. PLAY（Deal開始→Humanアクション→CPU自動）
3. DEAL_END表示（勝者・分配・次ディール）
4. HISTORY（DealSummary一覧）
5. SETTINGS（全データ削除）
6. フル詳細表示（直近10のみ）

---

## 9. 次のドキュメント
- 12_実装計画.md（フォルダ構成、責務分離、テスト戦略、作業順）
