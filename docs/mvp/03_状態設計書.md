# 03_状態設計書.md

## 1. 目的
本書は、MVP（CPU対戦・フロント完結）における **ディール単位のゲーム進行の正（Single Source of Truth）** を定義する。  
ゲームは **State / Event / Reducer** 方式で管理し、イベント列から同一の状態が再現できることを前提とする。

対象：Stud系（Stud Hi / Razz / Stud8）の **ベット進行（3rd〜7th）** と、ディール終了（全員fold or 7th完了 → ショーダウン）まで。

---

## 2. 命名・スコープ定義（重要）

### 2.1 DealState（ディール単位）
- `DealState` は **1ディール（= 1ハンド：開始〜誰かがポットを獲得するまで）** の状態を表す
- 本書で扱うのは基本的に `DealState`（進行エンジンの中心）

### 2.2 GameState（Mixゲーム全体）
- `GameState` は **複数ディールを束ねるゲーム全体**（Mixローテ、設定、累積結果など）を表す
- MVPでは `GameState` を最小で持つか、後続で導入してよい

### 2.3 AppState（アプリ全体）
- `AppState` は Zustand store のrootを想定し、画面状態・永続化・現在の `GameState` 参照などを含む

---

## 3. 設計原則

### 3.1 正規化（Stateは最小、導出は計算）
- Stateは「必要最小限の保存値」に絞る
- UI表示用の値（toCall 等）は selector で導出する
- ただし「正しさの根拠になる値（出資累計など）」は State に保持する

### 3.2 単一更新点
- 状態更新は `applyEvent(state, event)` のみ
- 行動判定は `getAllowedActions(state, seat)` のみ
- CPU・UIともにこの2点を経由する

### 3.3 3rd Streetの制約
- bring-in が必ず存在するため **check不可**
- bring-in はそのストリートの「ベット相当」として扱う

---

## 4. 用語定義（ストリート終了判定）

本MVPではストリート終了判定を安全に行うため、以下の2つを併用する（ハイブリッド方式）。

### 4.1 pendingResponseCount
- 「直近の攻撃アクション（bring-in / complete / bet / raise）に対して、まだ意思決定（call / fold）していない人数」

### 4.2 checksThisStreet
- 「このストリートで発生した CHECK の累積回数（active seatのcheckのみ）」
- ベットが一度でも入った後は、checkではなく call/fold/raise の世界になるため、**攻撃アクションが発生したタイミングで0にリセット**する

---

## 5. DealState構造（TypeScript想定）

```ts
export type GameType = "studHi" | "razz" | "stud8";
export type Street = "3rd" | "4th" | "5th" | "6th" | "7th";
export type SeatIndex = number;

export type PlayerKind = "human" | "cpu";

export interface PlayerState {
  seat: SeatIndex;
  kind: PlayerKind;

  active: boolean;
  stack: number; // 最小単位=ante

  // ディール内累計の出資額（整合性の根拠）
  committedTotal: number;

  // ストリート内の出資額（toCall / 終了判定の根拠）
  committedThisStreet: number;
}

export interface DealState {
  // 識別子
  dealId: string; // (= 1ディールID)
  gameType: GameType;

  // 構成
  playerCount: number; // 2〜7人
  players: PlayerState[];

  // ルール値（Fix Limit）
  ante: number;
  bringIn: number;
  smallBet: number;
  bigBet: number;

  // 現在のストリート
  street: Street;

  // 3rdのbring-in seat（3rd開始時に確定）
  bringInIndex: SeatIndex;

  // 次にアクションするseat
  currentActorIndex: SeatIndex;

  // ポット
  pot: number;

  // 現ストリートで「ベットとして成立している額」
  // 3rdはbringInがベット相当、completeでsmallBetへ引き上げ
  currentBet: number;

  // 現ストリートのレイズ回数（raiseイベント数）
  raiseCount: number;

  // 現ストリートの未応答者カウント
  pendingResponseCount: number;
  checksThisStreet: number;

  // 現ストリートのアクション履歴（イベントID参照でも可）
  actionsThisStreet: string[];

  // ハンド/ディール終了
  dealFinished: boolean;
}
```

---

## 6. 導出値（Selectors）

```ts
export const getActiveSeats = (s: DealState): SeatIndex[] =>
  s.players.filter(p => p.active).map(p => p.seat);

export const getPlayer = (s: DealState, seat: SeatIndex): PlayerState =>
  s.players[seat];

export const getStreetBetUnit = (s: DealState): number =>
  (s.street === "3rd" || s.street === "4th") ? s.smallBet : s.bigBet;

export const getToCall = (s: DealState, seat: SeatIndex): number => {
  const p = getPlayer(s, seat);
  return Math.max(0, s.currentBet - p.committedThisStreet);
};

export const canRaise = (s: DealState): boolean =>
  s.raiseCount < 4; // 5bet cap
```

---

## 7. ストリート別アクション仕様

### 7.1 3rd Street（bring-in）

#### 7.1.1 bring-inプレイヤー初手
- 許可：bring-in / complete
- 不可：check / bet / raise / call / fold

#### 7.1.2 bring-in後（complete未発生）
- 許可：fold / call(bring-in) / complete(smallBet)
- check不可

#### 7.1.3 complete後
- 許可：fold / call / raise（cap未到達時）
- complete不可

---

### 7.2 4th〜7th Street
- bet未発生（currentBet=0）
  - 許可：check / bet
- bet発生後（currentBet>0）
  - 許可：fold / call / raise（cap未到達時）

※ 5th以降は bigBet 単位

---

## 8. ストリート終了条件（ハイブリッド方式）

ストリートは以下のいずれかで終了する。

### 8.1 全員fold（ディール終了）
- activeが1人になった時点で dealFinished = true

### 8.2 攻撃アクションが発生している場合（pending方式）
- `pendingResponseCount === 0` になったらストリート終了（→ STREET_ADVANCE）

※ 攻撃アクション：bring-in / complete / bet / raise  
※ 応答アクション：call / fold（raiseは新たな攻撃なので pending を再設定）

### 8.3 攻撃アクションが発生していない場合（check方式）
- `currentBet === 0` かつ `checksThisStreet === active人数` になったらストリート終了（→ STREET_ADVANCE）

※ 4th以降のみ成立（3rdはcheck不可）
※ 3rd Street は CHECK 方式で終了しないため、pendingResponseCount は BRING_IN/COMPLETE 発生時にのみ設定(active-1で初期化)される（開始時は0でよい）

---

## 9. ストリート遷移時リセット
STREET_ADVANCE 適用時に以下をリセットする。

- players[*].committedThisStreet = 0
- currentBet = 0
- raiseCount = 0
- pendingResponseCount = 0
- checksThisStreet = 0
- actionsThisStreet = []
- street を次へ
- currentActorIndex を次ストリート先頭へ（Actor仕様）

---

## 10. Actor仕様（行動順序仕様）

### 10.1 共通ルール
- 行動順序は「activeなプレイヤーのみ」を対象に、seat順で巡回する
- `currentActorIndex` は常に active seat を指す（foldしたら次のactiveへ進める）
- タイブレークは「seatが小さい方を優先」（固定）とする

### 10.2 3rd Street：bring-in対象者の決定（詳細）
カード情報の有無で2段階に定義する。

#### 10.2.1 カード情報が利用可能な場合（推奨・将来互換）
- Stud Hi / Stud8：**最弱のアップカード**（rank最小）を持つプレイヤーがbring-in
- Razz：**最強のアップカード**（rank最大、ただしAceはLow＝A=1として扱うためKが最大）を持つプレイヤーがbring-in
- 同rankの場合：次のタイブレーク（スート順）→それでも同値ならseat最小
- スート順は実装で固定（例：♣ < ♦ < ♥ < ♠）
  - ただし、Razzの場合はスート順は逆順（♠ < ♥ < ♦ < ♣）とする
- 将来オンライン化しても同一にすること

#### 10.2.2 カード情報が未実装の場合（MVP暫定ルール）
- bring-inは `bringInIndex` を「hand開始時に擬似乱数で選ぶ」または「ディーラーボタン+1」として決定してよい
- 後で差し替え可能なように `computeBringInIndex(state)` の責務として分離する

### 10.3 3rd Street：アクション開始順
- bring-inの最初のアクターは `bringInIndex`
- bring-in確定後は `currentActorIndex` を次のactive seatへ進める

### 10.4 4th〜7th Street：先頭アクターの決定（詳細）
カード情報の有無で2段階に定義する。

#### 10.4.1 カード情報が利用可能な場合（推奨・将来互換）
- Stud Hi / Stud8：最強のアップカード構成を持つプレイヤーが先頭
- Razz：最弱のアップカード構成を持つプレイヤーが先頭
- 同値時：seat最小

※ 「アップカード構成の強弱」は、役判定ロジックと独立して簡易比較でよい（辞書式比較等）。

#### 10.4.2 カード情報が未実装の場合（MVP暫定ルール）
- 4th以降の先頭アクターは「固定でseat最小active」または「前ストリート先頭の次」でもよい
- 後で差し替え可能なように `getFirstActorForStreet(state, street)` の責務として分離する

---

## 11. 不正アクションの扱い
- applyEvent は不正イベントを拒否する
- UI / CPU は getAllowedActions を唯一の入力制御とする
- テストで不正ケースを必ず検証する

---

## 12. テスト観点（Vitest）
- 3rdでcheck不可
- complete後にcomplete不可
- 5bet cap超過不可
- 全員callでストリート終了
- 全員foldでディール終了
- bring-in/先頭アクター決定関数が「カード未実装でも動く」こと（暫定ルール）
- 4th以降：全員checkでストリート終了

---

## 13. 次のドキュメント
- 04_イベント設計書.md（Event定義・ペイロード・applyEvent責務境界）
- 05_計算仕様書.md（pot/stack/committed更新詳細、端数処理）
- 06_CPU設計書.md（chooseActionインターフェース、Lv0/Lv1）


### 【追記】3rd Street の COMPLETE 定義（Actor / Action 仕様の補足）

- COMPLETE は **3rd Street において、そのストリートで初めて smallBet を成立させる攻撃アクション**である。
- COMPLETE は以下すべてを満たす場合のみ発生し得る。
  - `street === "3rd"`
  - `player.committedThisStreet === 0`
  - `currentBet < smallBet`（= 0 または bringIn）
- bring-in 対象者が bring-in を行い、以降だれも COMPLETE / RAISE を行わずにコールで一周した場合、
  bring-in 対象者に追加のアクションは与えられず、**自動的に 4th Street へ進む**。